<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LENS LOG</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#f5f2ee;--surface:#fff;--surface2:#f0ece6;--border:#ddd8d0;--accent:#1a1a1a;--accent2:#b85c2a;--text:#1a1a1a;--muted:#888074;--ok:#2a7a4b;--ok-bg:#e8f5ee;--warn:#b85c2a;--warn-bg:#fdf0e8;--out:#8b1a1a;--out-bg:#fde8e8;--tag-bg:#ede9e3;--blue:#1e3a5f;--blue-bg:#e8eef7}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;min-height:100vh}
header{background:var(--accent);color:#fff;padding:0 32px;display:flex;align-items:stretch;min-height:64px;position:sticky;top:0;z-index:100}
.logo{display:flex;align-items:center;gap:12px;padding:16px 0;margin-right:32px}
.logo-ring{width:34px;height:34px;border:2px solid var(--accent2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px}
.logo-text{font-size:20px;font-weight:800;letter-spacing:3px;text-transform:uppercase}
.logo-text span{color:var(--accent2)}
.hstats{display:flex}
.hstat{padding:0 22px;display:flex;flex-direction:column;justify-content:center;border-left:1px solid rgba(255,255,255,.1);text-align:center}
.hstat-val{font-family:'DM Mono',monospace;font-size:19px;font-weight:500}
.hstat-lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.4);margin-top:2px}
.header-nav{margin-left:auto;display:flex;align-items:stretch}
.nav-btn{padding:0 22px;background:transparent;border:none;border-bottom:3px solid transparent;color:rgba(255,255,255,.5);font-family:'Syne',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:7px}
.nav-btn:hover{color:#fff}.nav-btn.active{color:#fff;border-bottom-color:var(--accent2)}
.page{display:none}.page.active{display:flex}
.form-row{margin-bottom:11px}
label{display:block;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:5px}
input,select,textarea{width:100%;background:var(--surface2);border:1.5px solid var(--border);color:var(--text);padding:8px 11px;font-family:'Syne',sans-serif;font-size:13px;outline:none;border-radius:4px;transition:border-color .15s}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
input::placeholder,textarea::placeholder{color:#bbb5ab}
textarea{resize:vertical;min-height:58px}
.btn{width:100%;padding:10px;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;border:none;border-radius:4px;transition:all .15s}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:#333;transform:translateY(-1px)}
.btn-ghost{background:transparent;color:var(--muted);border:1.5px solid var(--border)}.btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
.btn-sm{padding:5px 11px;font-family:'Syne',sans-serif;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;border-radius:3px;cursor:pointer;transition:all .15s}
.btn-sm-edit{background:transparent;color:var(--accent2);border:1.5px solid #f5d5c0}.btn-sm-edit:hover{background:var(--accent2);color:#fff}
.btn-sm-del{background:transparent;color:var(--out);border:1.5px solid #f5c5c5}.btn-sm-del:hover{background:var(--out);color:#fff;border-color:var(--out)}
.ibtn{padding:8px 16px;font-family:'Syne',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;border:none;border-radius:4px;transition:all .15s;white-space:nowrap}
.ibtn-primary{background:var(--accent);color:#fff}.ibtn-primary:hover{background:#333}
.ibtn-ghost{background:transparent;color:var(--muted);border:1.5px solid var(--border)}.ibtn-ghost:hover{border-color:var(--accent);color:var(--accent)}
.ibtn-danger{background:transparent;color:var(--out);border:1.5px solid #f5c5c5}.ibtn-danger:hover{background:var(--out);color:#fff}
.ibtn-success{background:var(--ok);color:#fff}.ibtn-success:hover{background:#1d5c38}
.ibtn-orange{background:var(--accent2);color:#fff}.ibtn-orange:hover{background:#8f4420}
.sidebar{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto}
.sb-section{padding:22px;border-bottom:1px solid var(--border)}
.sb-label{font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:14px}
.cat-item{display:flex;justify-content:space-between;align-items:center;padding:8px 11px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;transition:all .15s;margin-bottom:3px;color:var(--muted)}
.cat-item:hover{background:var(--surface2);color:var(--text)}.cat-item.active{background:var(--accent);color:#fff}
.cat-count{font-family:'DM Mono',monospace;font-size:11px;padding:1px 7px;border-radius:10px}
.cat-item.active .cat-count{background:rgba(255,255,255,.2)}.cat-item:not(.active) .cat-count{background:var(--tag-bg);color:var(--muted)}
#page-inventory{min-height:calc(100vh - 64px)}
.inv-layout{display:grid;grid-template-columns:272px 1fr;min-height:calc(100vh - 64px);width:100%}
.inv-content{padding:24px 28px;display:flex;flex-direction:column;gap:16px;overflow-y:auto}
.toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.search-wrap{position:relative;flex:1;min-width:180px;max-width:340px}
.search-wrap input{padding-left:34px}
.search-ico{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:13px;pointer-events:none}
.toolbar select{width:155px}
.view-toggle{margin-left:auto;display:flex;border:1.5px solid var(--border);border-radius:4px;overflow:hidden}
.vbtn{padding:7px 13px;background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:14px;transition:all .15s}.vbtn.active{background:var(--accent);color:#fff}
.table-wrap-outer{background:var(--surface);border:1.5px solid var(--border);border-radius:8px;overflow:hidden}
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{padding:9px 14px;text-align:left;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);background:var(--surface2);cursor:pointer;white-space:nowrap;user-select:none;border-bottom:2px solid var(--border)}
thead th:hover{color:var(--accent)}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
tbody tr:hover{background:var(--surface2)}tbody tr:last-child{border-bottom:none}
td{padding:12px 14px;vertical-align:middle}
.td-name{font-weight:700;font-size:14px}.td-sub{font-size:11px;color:var(--muted);margin-top:2px}
.sku-tag{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);background:var(--tag-bg);padding:2px 7px;border-radius:3px;display:inline-block}
.loc-tag{font-size:11px;color:var(--muted)}
.qty-cell{display:flex;align-items:center;gap:5px}
.qty-num{font-family:'DM Mono',monospace;font-size:17px;font-weight:500;min-width:32px;text-align:center}
.qty-btn{width:24px;height:24px;background:var(--surface2);border:1.5px solid var(--border);border-radius:3px;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;transition:all .12s;color:var(--text);line-height:1;flex-shrink:0}
.qty-btn:hover{background:var(--accent);border-color:var(--accent);color:#fff}
.cond-badge{display:inline-block;padding:2px 8px;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;border-radius:3px}
.cond-mint{background:#e8f5ee;color:var(--ok)}.cond-good{background:#eef5e8;color:#4a7a2a}
.cond-fair{background:var(--warn-bg);color:var(--warn)}.cond-poor{background:var(--out-bg);color:var(--out)}
.td-actions{display:flex;gap:5px;align-items:center}
.grid-view{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:14px}
.gc{background:var(--surface);border:1.5px solid var(--border);border-radius:8px;padding:18px;transition:all .2s}
.gc:hover{border-color:var(--accent2);box-shadow:0 4px 18px rgba(0,0,0,.07);transform:translateY(-2px)}
.gc-top{display:flex;justify-content:flex-end;margin-bottom:10px;min-height:22px}
.gc-name{font-size:15px;font-weight:700;margin-bottom:2px}.gc-cat{font-size:11px;color:var(--muted);margin-bottom:12px}
.gc-mid{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin-bottom:14px}
.gc-qty-wrap{display:flex;align-items:center;gap:7px}
.gc-qty{font-family:'DM Mono',monospace;font-size:30px;font-weight:500;line-height:1}
.gc-qty-lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted)}
.gc-foot{display:flex;gap:5px;margin-top:12px}.gc-foot button{flex:1}
.empty-state{text-align:center;padding:56px 20px;color:var(--muted)}
.empty-ico{font-size:42px;margin-bottom:10px}.empty-txt{font-size:15px;letter-spacing:1px;font-weight:600}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border-radius:10px;padding:28px;width:500px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2);animation:mIn .2s ease}
.modal-lg{width:660px}
@keyframes mIn{from{transform:translateY(-14px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-hdr{font-size:18px;font-weight:800;letter-spacing:1px;margin-bottom:22px;padding-bottom:13px;border-bottom:2px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-x{background:none;border:none;font-size:19px;cursor:pointer;color:var(--muted);line-height:1}.modal-x:hover{color:var(--text)}
.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:11px}.modal-full{grid-column:1/-1}
.modal-actions{display:flex;gap:10px;margin-top:18px}.modal-actions .btn{flex:1}
#page-trips{min-height:calc(100vh - 64px)}
.trips-layout{display:grid;grid-template-columns:300px 1fr;min-height:calc(100vh - 64px);width:100%}
.trips-sidebar{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto}
.trips-list{padding:14px;display:flex;flex-direction:column;gap:7px;flex:1}
.trip-thumb{border:1.5px solid var(--border);border-radius:8px;padding:13px 14px;cursor:pointer;transition:all .15s}
.trip-thumb:hover{border-color:var(--accent2);background:var(--surface2)}
.trip-thumb.selected{border-color:var(--accent);background:var(--surface2);box-shadow:0 0 0 2px rgba(26,26,26,.08)}
.trip-thumb-name{font-weight:700;font-size:14px;margin-bottom:4px}
.trip-thumb-meta{font-size:11px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.trip-thumb-foot{display:flex;align-items:center;justify-content:space-between}
.trip-del-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px;padding:2px 5px;border-radius:3px;transition:all .12s;line-height:1}
.trip-del-btn:hover{background:var(--out-bg);color:var(--out)}
.trip-status{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase}
.ts-planned{background:var(--tag-bg);color:var(--muted)}.ts-active{background:var(--blue-bg);color:var(--blue)}.ts-done{background:var(--ok-bg);color:var(--ok)}
.trips-main{padding:24px 28px;display:flex;flex-direction:column;gap:18px;overflow-y:auto;height:calc(100vh - 64px)}
.trip-detail-hdr{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px}
.trip-detail-title{font-size:24px;font-weight:800}
.trip-detail-meta{font-size:12px;color:var(--muted);margin-top:4px}
.trip-detail-actions{display:flex;gap:7px;flex-wrap:wrap}
.sum-bar{display:flex;gap:14px;flex-wrap:wrap}
.sum-card{background:var(--surface);border:1.5px solid var(--border);border-radius:8px;padding:13px 18px;display:flex;flex-direction:column;gap:2px;min-width:110px}
.sum-val{font-family:'DM Mono',monospace;font-size:24px;font-weight:500}
.sum-lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted)}
.section-card{background:var(--surface);border:1.5px solid var(--border);border-radius:8px;overflow:hidden}
.sc-hdr{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:var(--surface2);border-bottom:1.5px solid var(--border)}
.sc-title{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted)}
.gear-row{display:flex;align-items:center;gap:12px;padding:11px 18px;border-bottom:1px solid var(--border)}
.gear-row:last-child{border-bottom:none}
.gear-name{font-weight:600;font-size:14px;flex:1}.gear-cat{font-size:11px;color:var(--muted)}
.gear-qty{font-family:'DM Mono',monospace;font-size:17px;font-weight:500;color:var(--blue);min-width:60px;text-align:right;padding-right:8px}
.picker-list{display:flex;flex-direction:column;gap:6px;max-height:320px;overflow-y:auto;padding-right:2px;margin-bottom:6px}
.picker-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border:1.5px solid var(--border);border-radius:6px;transition:border-color .15s,background .15s}
.picker-item:hover{background:var(--surface2)}.picker-item.selected{border-color:var(--accent);background:var(--surface2)}
.picker-name{font-weight:600;font-size:13px}.picker-cat{font-size:10px;color:var(--muted)}
.picker-avail{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);white-space:nowrap;flex-shrink:0}
.picker-qty{width:68px!important;padding:5px 8px!important;font-size:13px!important;font-family:'DM Mono',monospace!important;text-align:center!important;flex-shrink:0}
.load-summary{font-size:12px;font-weight:600;min-height:18px;padding:4px 0}
.trip-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;padding:60px 40px;color:var(--muted)}
.trip-empty-ico{font-size:52px;margin-bottom:14px}
.trip-empty-title{font-size:18px;font-weight:800;color:var(--text);margin-bottom:8px}
.trip-empty-sub{font-size:13px;line-height:1.7}
.toast{position:fixed;bottom:24px;right:24px;padding:11px 20px;background:var(--accent);color:#fff;font-size:12px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;border-radius:6px;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.18);animation:tIn .25s ease;pointer-events:none}
.toast.error{background:var(--out)}
@keyframes tIn{from{transform:translateY(14px);opacity:0}to{transform:translateY(0);opacity:1}}
.hidden{display:none!important}
@media(max-width:800px){.inv-layout,.trips-layout{grid-template-columns:1fr}.sidebar,.trips-sidebar{display:none}}
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-ring">&#x1F4F7;</div>
    <div class="logo-text">LENS<span>LOG</span></div>
  </div>
  <div class="hstats">
    <div class="hstat"><div class="hstat-val" id="stat-items">0</div><div class="hstat-lbl">Items</div></div>
    <div class="hstat"><div class="hstat-val" id="stat-units">0</div><div class="hstat-lbl">Units</div></div>
    <div class="hstat"><div class="hstat-val" id="stat-cats">0</div><div class="hstat-lbl">Categories</div></div>
    <div class="hstat"><div class="hstat-val" id="stat-trips">0</div><div class="hstat-lbl">Active Trips</div></div>
  </div>
  <div class="header-nav">
    <button class="nav-btn active" id="nav-inventory" onclick="showPage('inventory')">&#x1F4E6; Inventory</button>
    <button class="nav-btn"        id="nav-trips"     onclick="showPage('trips')">&#x2708;&#xFE0F; Trips</button>
  </div>
</header>

<!-- INVENTORY PAGE -->
<div class="page active" id="page-inventory">
  <div class="inv-layout">
    <aside class="sidebar">
      <div class="sb-section">
        <div class="sb-label">Add Equipment</div>
        <div class="form-row"><label>Item Name *</label><input type="text" id="inp-name" placeholder="e.g. Sony A7 IV"></div>
        <div class="form-row">
          <label>Category</label>
          <select id="inp-cat">
            <option value="">Select category...</option>
            <option>Cameras</option><option>Lenses</option><option>Lighting</option>
            <option>Tripods &amp; Support</option><option>Audio</option><option>Storage &amp; Media</option>
            <option>Batteries &amp; Power</option><option>Bags &amp; Cases</option><option>Filters</option>
            <option>Accessories</option><option>Studio Props</option><option>Other</option>
          </select>
        </div>
        <div class="form-row"><label>Quantity *</label><input type="number" id="inp-qty" placeholder="1" min="0"></div>
        <div class="form-row">
          <label>Condition</label>
          <select id="inp-cond">
            <option value="">Select...</option>
            <option>Mint</option><option>Good</option><option>Fair</option><option>Poor</option>
          </select>
        </div>
        <div class="form-row"><label>Serial / Asset No.</label><input type="text" id="inp-serial" placeholder="SN-..."></div>
        <div class="form-row"><label>Storage Location</label><input type="text" id="inp-location" placeholder="e.g. Shelf A2"></div>
        <div class="form-row"><label>Notes</label><textarea id="inp-notes" placeholder="Accessories, known issues..."></textarea></div>
        <button class="btn btn-primary" onclick="addItem()">+ Add Equipment</button>
      </div>
      <div class="sb-section">
        <div class="sb-label">Filter by Category</div>
        <div id="cat-list"></div>
      </div>
      <div class="sb-section">
        <div class="sb-label">Export</div>
        <button class="btn btn-primary" onclick="exportCSV()" style="margin-bottom:8px">Export CSV</button>
        <button class="btn btn-ghost"   onclick="exportJSON()">Export JSON</button>
      </div>
    </aside>

    <div class="inv-content">
      <div class="toolbar">
        <div class="search-wrap">
          <span class="search-ico">&#x1F50D;</span>
          <input type="text" id="search-input" placeholder="Search equipment..." oninput="renderInventory()">
        </div>
        <select id="sort-field" onchange="renderInventory()">
          <option value="name">Sort: Name</option>
          <option value="qty">Sort: Quantity</option>
          <option value="cat">Sort: Category</option>
          <option value="cond">Sort: Condition</option>
        </select>
        <select id="sort-dir" onchange="renderInventory()">
          <option value="asc">&#x2191; Asc</option>
          <option value="desc">&#x2193; Desc</option>
        </select>
        <div class="view-toggle">
          <button class="vbtn active" id="vbtn-table" onclick="switchView('table')">&#x2630;</button>
          <button class="vbtn"        id="vbtn-grid"  onclick="switchView('grid')">&#x229E;</button>
        </div>
      </div>

      <div id="view-table" class="table-wrap-outer">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th onclick="sortBy('name')">Item</th>
                <th onclick="sortBy('cat')">Category</th>
                <th onclick="sortBy('qty')">Quantity</th>
                <th onclick="sortBy('cond')">Condition</th>
                <th>Location</th>
                <th>Serial</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="table-body"></tbody>
          </table>
        </div>
        <div id="table-empty" class="empty-state hidden">
          <div class="empty-ico">&#x1F4F7;</div>
          <div class="empty-txt">No equipment found</div>
        </div>
      </div>
      <div id="view-grid" class="grid-view hidden"></div>
    </div>
  </div>
</div>

<!-- TRIPS PAGE -->
<div class="page" id="page-trips">
  <div class="trips-layout">
    <div class="trips-sidebar">
      <div class="sb-section">
        <div class="sb-label">New Trip</div>
        <div class="form-row"><label>Trip Name *</label><input type="text" id="trip-name" placeholder="NYC Fashion Shoot"></div>
        <div class="form-row"><label>Location</label><input type="text" id="trip-loc" placeholder="Brooklyn, NY"></div>
        <div class="form-row"><label>Date</label><input type="date" id="trip-date"></div>
        <div class="form-row"><label>Notes</label><textarea id="trip-notes" placeholder="Client, brief..." style="min-height:46px"></textarea></div>
        <button class="btn btn-primary" onclick="createTrip()">+ Create Trip</button>
      </div>
      <div class="trips-list" id="trips-list">
        <div style="text-align:center;padding:18px;color:var(--muted);font-size:12px">No trips yet</div>
      </div>
    </div>
    <div class="trips-main" id="trips-main">
      <div class="trip-empty">
        <div class="trip-empty-ico">&#x2708;&#xFE0F;</div>
        <div class="trip-empty-title">Select or Create a Trip</div>
        <div class="trip-empty-sub">Create a trip on the left, load your equipment,<br>and unload everything when you return.</div>
      </div>
    </div>
  </div>
</div>

<!-- EDIT ITEM MODAL -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-hdr">Edit Equipment <button class="modal-x" onclick="closeModal('edit-modal')">&#x2715;</button></div>
    <input type="hidden" id="edit-id">
    <div class="modal-grid">
      <div class="modal-full form-row"><label>Item Name *</label><input type="text" id="edit-name"></div>
      <div class="form-row">
        <label>Category</label>
        <select id="edit-cat">
          <option value="">Select...</option>
          <option>Cameras</option><option>Lenses</option><option>Lighting</option>
          <option>Tripods &amp; Support</option><option>Audio</option><option>Storage &amp; Media</option>
          <option>Batteries &amp; Power</option><option>Bags &amp; Cases</option><option>Filters</option>
          <option>Accessories</option><option>Studio Props</option><option>Other</option>
        </select>
      </div>
      <div class="form-row">
        <label>Condition</label>
        <select id="edit-cond">
          <option value="">Select...</option>
          <option>Mint</option><option>Good</option><option>Fair</option><option>Poor</option>
        </select>
      </div>
      <div class="form-row"><label>Quantity</label><input type="number" id="edit-qty" min="0"></div>
      <div class="form-row"><label>Serial / Asset</label><input type="text" id="edit-serial"></div>
      <div class="modal-full form-row"><label>Storage Location</label><input type="text" id="edit-location"></div>
      <div class="modal-full form-row"><label>Notes</label><textarea id="edit-notes"></textarea></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost"   onclick="closeModal('edit-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- LOAD GEAR MODAL -->
<div class="modal-overlay" id="load-modal">
  <div class="modal modal-lg">
    <div class="modal-hdr">Load Equipment into Trip <button class="modal-x" onclick="closeModal('load-modal')">&#x2715;</button></div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:14px">Type a quantity next to each item. Those units will be deducted from your inventory.</p>
    <div class="form-row" style="margin-bottom:10px">
      <input type="text" id="load-search" placeholder="Filter equipment..." oninput="renderPicker()">
    </div>
    <div class="picker-list" id="picker-list"></div>
    <div class="load-summary" id="load-summary" style="color:var(--muted)">Enter quantities above to select items.</div>
    <div class="modal-actions">
      <button class="btn btn-ghost"   onclick="closeModal('load-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="confirmLoad()">Load Equipment</button>
    </div>
  </div>
</div>

<script>
'use strict';

// ── ID GENERATOR (always integer, no collisions, no floats) ──────────────────
var _nid = parseInt(localStorage.getItem('ll_nid') || '1', 10);
function nextId() {
  var id = _nid++;
  localStorage.setItem('ll_nid', String(_nid));
  return id;
}

// ── STATE ────────────────────────────────────────────────────────────────────
var items = [];
var trips = [];
var currentCat    = 'all';
var currentView   = 'table';
var sortField     = 'name';
var sortDir       = 'asc';
var selectedTripId = null;
var pickerSels    = {};   // { itemId(number) : qty(number) }

// ── PERSISTENCE ──────────────────────────────────────────────────────────────
function persist() {
  localStorage.setItem('ll_items', JSON.stringify(items));
  localStorage.setItem('ll_trips', JSON.stringify(trips));
}

function loadData() {
  try { items = JSON.parse(localStorage.getItem('ll_items') || '[]'); } catch(e) { items = []; }
  try { trips = JSON.parse(localStorage.getItem('ll_trips') || '[]'); } catch(e) { trips = []; }
  // Ensure all IDs are numbers (migration safety)
  items.forEach(function(i) { i.id = Number(i.id); });
  trips.forEach(function(t) {
    t.id = Number(t.id);
    if (!Array.isArray(t.gear)) t.gear = [];
    t.gear.forEach(function(g) { g.itemId = Number(g.itemId); });
  });
  if (!items.length) seedData();
}

function seedData() {
  var seeds = [
    {name:'Sony A7 IV',              cat:'Cameras',           qty:2, cond:'Mint', serial:'SN-SOA7-0042', location:'Camera Shelf A1',    notes:'Full frame, 33MP'},
    {name:'Canon EF 50mm f/1.4',     cat:'Lenses',            qty:3, cond:'Good', serial:'',             location:'Lens Cabinet B2',    notes:''},
    {name:'Sigma 24-70mm f/2.8 Art', cat:'Lenses',            qty:1, cond:'Good', serial:'SG-2470-019',  location:'Lens Cabinet B3',    notes:'Slight dust on rear element'},
    {name:'Godox SL-60W LED',        cat:'Lighting',          qty:4, cond:'Good', serial:'',             location:'Studio Rack C1',     notes:''},
    {name:'Manfrotto 055XPRO3',      cat:'Tripods & Support', qty:2, cond:'Fair', serial:'',             location:'Gear Closet D1',     notes:'One missing rubber foot'},
    {name:'Rode VideoMicro',         cat:'Audio',             qty:2, cond:'Good', serial:'RD-VM-007',    location:'Audio Box E1',       notes:''},
    {name:'SanDisk Extreme 128GB',   cat:'Storage & Media',   qty:8, cond:'Good', serial:'',             location:'Card Wallet F1',     notes:''},
    {name:'LP-E6NH Battery',         cat:'Batteries & Power', qty:4, cond:'Fair', serial:'',             location:'Charging Station G1',notes:'~70% capacity'},
  ];
  seeds.forEach(function(s) {
    items.push(Object.assign({id: nextId(), createdAt: new Date().toISOString()}, s));
  });
  persist();
}

// ── UTILS ────────────────────────────────────────────────────────────────────
function esc(s) {
  return String(s == null ? '' : s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function condClass(c) {
  return {Mint:'cond-mint',Good:'cond-good',Fair:'cond-fair',Poor:'cond-poor'}[c] || '';
}
function tsCls(s)  { return {planned:'ts-planned',active:'ts-active',done:'ts-done'}[s] || 'ts-planned'; }
function tsLbl(s)  { return {planned:'Planned',active:'Active',done:'Done'}[s] || s; }
function itemById(id) { return items.find(function(i){return i.id===id;}) || null; }
function tripById(id) { return trips.find(function(t){return t.id===id;}) || null; }

// ── PAGE NAV ─────────────────────────────────────────────────────────────────
function showPage(name) {
  document.querySelectorAll('.page').forEach(function(p){p.classList.remove('active');});
  document.querySelectorAll('.nav-btn').forEach(function(b){b.classList.remove('active');});
  document.getElementById('page-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
  if (name === 'trips') renderTripsPage();
}

// ── STATS ────────────────────────────────────────────────────────────────────
function renderStats() {
  document.getElementById('stat-items').textContent = items.length;
  document.getElementById('stat-units').textContent = items.reduce(function(s,i){return s+(i.qty||0);},0);
  document.getElementById('stat-cats').textContent  = new Set(items.map(function(i){return i.cat;})).size;
  document.getElementById('stat-trips').textContent = trips.filter(function(t){return t.status==='active';}).length;
}

// ── INVENTORY ────────────────────────────────────────────────────────────────
function getFiltered() {
  var q  = document.getElementById('search-input').value.toLowerCase();
  var sf = document.getElementById('sort-field').value;
  var sd = document.getElementById('sort-dir').value;
  return items
    .filter(function(i) {
      var mc = currentCat==='all' || i.cat===currentCat;
      var mq = !q || [i.name,i.cat,i.serial,i.location,i.notes].some(function(v){return (v||'').toLowerCase().includes(q);});
      return mc && mq;
    })
    .sort(function(a,b) {
      var va,vb;
      if      (sf==='qty')  {va=a.qty||0;   vb=b.qty||0;}
      else if (sf==='cat')  {va=a.cat||'';  vb=b.cat||'';}
      else if (sf==='cond') {va=a.cond||''; vb=b.cond||'';}
      else                  {va=a.name||''; vb=b.name||'';}
      if (typeof va==='number') return sd==='asc'?va-vb:vb-va;
      return sd==='asc'?va.localeCompare(vb):vb.localeCompare(va);
    });
}

function renderCats() {
  var cats = Array.from(new Set(items.map(function(i){return i.cat;}))).sort();
  var el = document.getElementById('cat-list');
  el.innerHTML =
    '<div class="cat-item '+(currentCat==='all'?'active':'')+'" onclick="filterCat(\'all\')">'
    +'All Equipment <span class="cat-count">'+items.length+'</span></div>'
    + cats.map(function(c) {
        var n = items.filter(function(i){return i.cat===c;}).length;
        return '<div class="cat-item '+(currentCat===c?'active':'')+'" onclick="filterCat('+JSON.stringify(c)+')">'
               +esc(c)+' <span class="cat-count">'+n+'</span></div>';
      }).join('');
}

function renderInventory() {
  if (currentView==='table') renderTable(getFiltered());
  else renderGrid(getFiltered());
}

function renderTable(filtered) {
  var tbody = document.getElementById('table-body');
  var empty = document.getElementById('table-empty');
  if (!filtered.length) { tbody.innerHTML=''; empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');
  tbody.innerHTML = filtered.map(function(i) {
    var cc = condClass(i.cond);
    return '<tr>'
      +'<td><div class="td-name">'+esc(i.name)+'</div>'+(i.notes?'<div class="td-sub">'+esc(i.notes.slice(0,60))+(i.notes.length>60?'...':'')+'</div>':'')+'</td>'
      +'<td><span style="font-size:12px;font-weight:600">'+esc(i.cat||'--')+'</span></td>'
      +'<td><div class="qty-cell"><button class="qty-btn" onclick="adjustQty('+i.id+',-1)">-</button><span class="qty-num">'+i.qty+'</span><button class="qty-btn" onclick="adjustQty('+i.id+',1)">+</button></div></td>'
      +'<td>'+(i.cond?'<span class="cond-badge '+cc+'">'+esc(i.cond)+'</span>':'<span style="color:var(--muted)">--</span>')+'</td>'
      +'<td>'+(i.location?'<span class="loc-tag">&#x1F4CD; '+esc(i.location)+'</span>':'<span style="color:var(--muted)">--</span>')+'</td>'
      +'<td>'+(i.serial?'<span class="sku-tag">'+esc(i.serial)+'</span>':'<span style="color:var(--muted)">--</span>')+'</td>'
      +'<td><div class="td-actions"><button class="btn-sm btn-sm-edit" onclick="openEditModal('+i.id+')">Edit</button><button class="btn-sm btn-sm-del" onclick="deleteItem('+i.id+')">Remove</button></div></td>'
      +'</tr>';
  }).join('');
}

function renderGrid(filtered) {
  var el = document.getElementById('view-grid');
  if (!filtered.length) { el.innerHTML='<div class="empty-state"><div class="empty-ico">&#x1F4F7;</div><div class="empty-txt">No equipment found</div></div>'; return; }
  el.innerHTML = filtered.map(function(i) {
    var cc = condClass(i.cond);
    return '<div class="gc">'
      +'<div class="gc-top">'+(i.cond?'<span class="cond-badge '+cc+'">'+esc(i.cond)+'</span>':'')+'</div>'
      +'<div class="gc-name">'+esc(i.name)+'</div>'
      +'<div class="gc-cat">'+esc(i.cat||'--')+'</div>'
      +'<div class="gc-mid"><div class="gc-qty-wrap"><button class="qty-btn" onclick="adjustQty('+i.id+',-1)">-</button><div><div class="gc-qty">'+i.qty+'</div><div class="gc-qty-lbl">Units</div></div><button class="qty-btn" onclick="adjustQty('+i.id+',1)">+</button></div>'+(i.location?'<span class="loc-tag">&#x1F4CD; '+esc(i.location)+'</span>':'')+'</div>'
      +(i.serial?'<div style="font-family:\'DM Mono\',monospace;font-size:10px;color:var(--muted)">S/N: '+esc(i.serial)+'</div>':'')
      +(i.notes?'<div style="font-size:11px;color:var(--muted);margin-top:6px">'+esc(i.notes.slice(0,70))+(i.notes.length>70?'...':'')+'</div>':'')
      +'<div class="gc-foot"><button class="btn-sm btn-sm-edit" onclick="openEditModal('+i.id+')">Edit</button><button class="btn-sm btn-sm-del" onclick="deleteItem('+i.id+')">Remove</button></div>'
      +'</div>';
  }).join('');
}

function filterCat(cat) { currentCat=cat; renderAll(); }

function switchView(v) {
  currentView=v;
  document.getElementById('view-table').classList.toggle('hidden',v!=='table');
  document.getElementById('view-grid').classList.toggle('hidden',v!=='grid');
  document.getElementById('vbtn-table').classList.toggle('active',v==='table');
  document.getElementById('vbtn-grid').classList.toggle('active',v==='grid');
  renderInventory();
}

function sortBy(field) {
  if (sortField===field) sortDir=sortDir==='asc'?'desc':'asc';
  else {sortField=field;sortDir='asc';}
  document.getElementById('sort-field').value=field;
  document.getElementById('sort-dir').value=sortDir;
  renderInventory();
}

function renderAll() { renderStats(); renderCats(); renderInventory(); }

// ── ITEM CRUD ────────────────────────────────────────────────────────────────
function addItem() {
  var name = document.getElementById('inp-name').value.trim();
  if (!name) { showToast('Item name is required!',true); return; }
  var qty = parseInt(document.getElementById('inp-qty').value,10);
  if (isNaN(qty)||qty<0) { showToast('Enter a valid quantity',true); return; }
  items.push({
    id:        nextId(),
    name:      name,
    cat:       document.getElementById('inp-cat').value||'Other',
    qty:       qty,
    cond:      document.getElementById('inp-cond').value,
    serial:    document.getElementById('inp-serial').value.trim(),
    location:  document.getElementById('inp-location').value.trim(),
    notes:     document.getElementById('inp-notes').value.trim(),
    createdAt: new Date().toISOString(),
  });
  persist();
  ['inp-name','inp-qty','inp-serial','inp-location','inp-notes'].forEach(function(id){document.getElementById(id).value='';});
  document.getElementById('inp-cat').value='';
  document.getElementById('inp-cond').value='';
  renderAll(); showToast('Equipment added!');
}

function adjustQty(id,delta) {
  var item=itemById(id); if(!item) return;
  item.qty=Math.max(0,(item.qty||0)+delta);
  persist(); renderAll();
}

function deleteItem(id) {
  if(!confirm('Remove this item from inventory?')) return;
  items=items.filter(function(i){return i.id!==id;});
  persist(); renderAll(); showToast('Item removed');
}

function openEditModal(id) {
  var i=itemById(id); if(!i) return;
  document.getElementById('edit-id').value       = id;
  document.getElementById('edit-name').value     = i.name;
  document.getElementById('edit-cat').value      = i.cat||'';
  document.getElementById('edit-qty').value      = i.qty;
  document.getElementById('edit-cond').value     = i.cond||'';
  document.getElementById('edit-serial').value   = i.serial||'';
  document.getElementById('edit-location').value = i.location||'';
  document.getElementById('edit-notes').value    = i.notes||'';
  openModal('edit-modal');
}

function saveEdit() {
  var id=parseInt(document.getElementById('edit-id').value,10);
  var item=itemById(id); if(!item) return;
  var name=document.getElementById('edit-name').value.trim();
  if(!name){showToast('Name is required',true);return;}
  item.name     = name;
  item.cat      = document.getElementById('edit-cat').value||item.cat;
  item.qty      = Math.max(0,parseInt(document.getElementById('edit-qty').value,10)||0);
  item.cond     = document.getElementById('edit-cond').value;
  item.serial   = document.getElementById('edit-serial').value.trim();
  item.location = document.getElementById('edit-location').value.trim();
  item.notes    = document.getElementById('edit-notes').value.trim();
  persist(); closeModal('edit-modal'); renderAll(); showToast('Saved!');
}

// ── EXPORT ───────────────────────────────────────────────────────────────────
function exportCSV() {
  if(!items.length){showToast('Nothing to export',true);return;}
  var h=['Name','Category','Qty','Condition','Serial','Location','Notes'];
  var rows=items.map(function(i){return[i.name,i.cat||'',i.qty,i.cond||'',i.serial||'',i.location||'',i.notes||''];});
  var csv=[h].concat(rows).map(function(r){return r.map(function(v){return'"'+String(v).replace(/"/g,'""')+'"';}).join(',');}).join('\n');
  dlFile('lenslog_inventory.csv',csv,'text/csv'); showToast('CSV exported!');
}
function exportJSON() {
  if(!items.length){showToast('Nothing to export',true);return;}
  dlFile('lenslog_data.json',JSON.stringify({items:items,trips:trips},null,2),'application/json'); showToast('JSON exported!');
}
function dlFile(name,content,type) {
  var a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([content],{type:type}));
  a.download=name; a.click();
}

// ── TRIPS ────────────────────────────────────────────────────────────────────
function createTrip() {
  var name=document.getElementById('trip-name').value.trim();
  if(!name){showToast('Trip name is required!',true);return;}
  var trip={
    id:        nextId(),
    name:      name,
    location:  document.getElementById('trip-loc').value.trim(),
    date:      document.getElementById('trip-date').value,
    notes:     document.getElementById('trip-notes').value.trim(),
    status:    'planned',
    gear:      [],
    createdAt: new Date().toISOString(),
  };
  trips.unshift(trip);
  persist();
  ['trip-name','trip-loc','trip-date','trip-notes'].forEach(function(id){document.getElementById(id).value='';});
  selectedTripId=trip.id;
  renderStats(); renderTripsPage(); showToast('Trip created!');
}

function deleteTrip(id) {
  var t=tripById(id); if(!t) return;
  var msg=(t.status==='active'&&t.gear.length)
    ?'This trip has loaded gear. Deleting will NOT return gear to inventory. Continue?'
    :'Delete this trip?';
  if(!confirm(msg)) return;
  trips=trips.filter(function(x){return x.id!==id;});
  if(selectedTripId===id) selectedTripId=null;
  persist(); renderStats(); renderTripsPage(); showToast('Trip deleted');
}

function setTripStatus(id,status) {
  var t=tripById(id); if(!t) return;
  t.status=status; persist(); renderStats(); renderTripsPage(); showToast('Status updated');
}

function removeGear(tripId,itemId) {
  var t=tripById(tripId); if(!t) return;
  var g=t.gear.find(function(x){return x.itemId===itemId;}); if(!g) return;
  if(!confirm('Remove '+g.itemName+' from this trip? '+g.qty+' unit'+(g.qty!==1?'s':'')+' will return to inventory.')) return;
  var item=itemById(itemId);
  if(item) item.qty+=g.qty;
  t.gear=t.gear.filter(function(x){return x.itemId!==itemId;});
  persist(); renderAll(); renderTripsPage(); showToast('Gear removed & returned to inventory');
}

function unloadTrip(id) {
  var t=tripById(id); if(!t) return;
  var total=t.gear.reduce(function(s,g){return s+g.qty;},0);
  if(!confirm('Return all '+total+' unit'+(total!==1?'s':'')+' to inventory and complete this trip?')) return;
  t.gear.forEach(function(g){var item=itemById(g.itemId);if(item)item.qty+=g.qty;});
  t.status='done';
  persist(); renderAll(); renderTripsPage(); showToast('Equipment unloaded -- trip complete!');
}

function renderTripsPage() { renderTripsList(); renderTripDetail(); }

function renderTripsList() {
  var el=document.getElementById('trips-list');
  if(!trips.length){el.innerHTML='<div style="text-align:center;padding:18px;color:var(--muted);font-size:12px">No trips yet</div>';return;}
  var ordered=trips.slice().sort(function(a,b){var o={active:0,planned:1,done:2};return((o[a.status]||1))-(o[b.status]||1);});
  el.innerHTML=ordered.map(function(t){
    var units=t.gear.reduce(function(s,g){return s+g.qty;},0);
    return '<div class="trip-thumb'+(selectedTripId===t.id?' selected':'')+'" onclick="selectTrip('+t.id+')">'
      +'<div class="trip-thumb-name">'+esc(t.name)+'</div>'
      +'<div class="trip-thumb-meta">'+(t.date?'<span>&#x1F4C5; '+t.date+'</span>':'')+(t.location?'<span>&#x1F4CD; '+esc(t.location)+'</span>':'')+'<span>&#x1F9F3; '+units+' unit'+(units!==1?'s':'')+'</span></div>'
      +'<div class="trip-thumb-foot"><span class="trip-status '+tsCls(t.status)+'">'+tsLbl(t.status)+'</span><button class="trip-del-btn" onclick="event.stopPropagation();deleteTrip('+t.id+')" title="Delete">&#x2715;</button></div>'
      +'</div>';
  }).join('');
}

function selectTrip(id) { selectedTripId=id; renderTripsPage(); }

function renderTripDetail() {
  var main=document.getElementById('trips-main');
  if(!selectedTripId){
    main.innerHTML='<div class="trip-empty"><div class="trip-empty-ico">&#x2708;&#xFE0F;</div><div class="trip-empty-title">Select or Create a Trip</div><div class="trip-empty-sub">Create a trip on the left, load your equipment,<br>and unload everything when you return.</div></div>';
    return;
  }
  var t=tripById(selectedTripId); if(!t){main.innerHTML='';return;}
  var totalUnits=t.gear.reduce(function(s,g){return s+g.qty;},0);

  var actions='';
  if(t.status==='planned'){
    actions='<button class="ibtn ibtn-primary" onclick="openLoadModal()">+ Load Equipment</button>'
           +'<button class="ibtn ibtn-orange"  onclick="setTripStatus('+t.id+',\'active\')">Mark Active</button>'
           +'<button class="ibtn ibtn-danger"  onclick="deleteTrip('+t.id+')">Delete</button>';
  } else if(t.status==='active'){
    actions='<button class="ibtn ibtn-primary" onclick="openLoadModal()">+ Load More</button>'
           +'<button class="ibtn ibtn-success" onclick="unloadTrip('+t.id+')">&#x2713; Unload &amp; Complete</button>'
           +'<button class="ibtn ibtn-danger"  onclick="deleteTrip('+t.id+')">Delete</button>';
  } else {
    actions='<button class="ibtn ibtn-ghost" onclick="deleteTrip('+t.id+')">Delete Trip</button>';
  }

  var gearHtml=!t.gear.length
    ?'<div style="padding:22px;text-align:center;color:var(--muted);font-size:13px">No equipment loaded yet'+(t.status!=='done'?' -- click <strong>Load Equipment</strong> to add gear':'')+'.</div>'
    :t.gear.map(function(g){
      return '<div class="gear-row">'
        +'<div style="flex:1"><div class="gear-name">'+esc(g.itemName)+'</div><div class="gear-cat">'+esc(g.itemCat||'')+'</div></div>'
        +'<div class="gear-qty">'+g.qty+' unit'+(g.qty!==1?'s':'')+'</div>'
        +(t.status!=='done'?'<button class="btn-sm btn-sm-del" onclick="removeGear('+t.id+','+g.itemId+')">Remove</button>':'')
        +'</div>';
    }).join('');

  main.innerHTML=
    '<div class="trip-detail-hdr"><div>'
    +'<div style="display:flex;align-items:center;gap:10px;margin-bottom:5px"><div class="trip-detail-title">'+esc(t.name)+'</div><span class="trip-status '+tsCls(t.status)+'">'+tsLbl(t.status)+'</span></div>'
    +'<div class="trip-detail-meta">'+(t.date?'&#x1F4C5; '+t.date+' &nbsp;':'')+(t.location?'&#x1F4CD; '+esc(t.location)+' &nbsp;':'')+(t.notes?'&#x1F4DD; '+esc(t.notes.slice(0,70))+(t.notes.length>70?'...':''):'')+'</div>'
    +'</div><div class="trip-detail-actions">'+actions+'</div></div>'
    +'<div class="sum-bar">'
    +'<div class="sum-card"><div class="sum-val">'+t.gear.length+'</div><div class="sum-lbl">Line Items</div></div>'
    +'<div class="sum-card"><div class="sum-val">'+totalUnits+'</div><div class="sum-lbl">Total Units</div></div>'
    +'<div class="sum-card"><div class="sum-val">'+tsLbl(t.status)+'</div><div class="sum-lbl">Status</div></div>'
    +'</div>'
    +'<div class="section-card"><div class="sc-hdr"><div class="sc-title">Loaded Equipment</div>'
    +(t.status==='done'?'<span style="font-size:11px;color:var(--ok)">&#x2713; All gear returned to inventory</span>'
      :(totalUnits?'<span style="font-size:11px;color:var(--muted)">'+totalUnits+' unit'+(totalUnits!==1?'s':'')+' out of inventory</span>':''))
    +'</div>'+gearHtml+'</div>';
}

// ── LOAD MODAL ───────────────────────────────────────────────────────────────
function openLoadModal() {
  if(!selectedTripId) return;
  pickerSels={};
  document.getElementById('load-search').value='';
  renderPicker();
  openModal('load-modal');
}

function renderPicker() {
  var q    = document.getElementById('load-search').value.toLowerCase();
  var trip = tripById(selectedTripId);
  var list = document.getElementById('picker-list');
  var available = items.filter(function(i){
    return i.qty>0 && (!q||i.name.toLowerCase().includes(q)||(i.cat||'').toLowerCase().includes(q));
  });
  if(!available.length){
    list.innerHTML='<div style="text-align:center;padding:18px;color:var(--muted);font-size:13px">No available equipment'+(q?' matching filter':'')+'</div>';
    updatePickerSummary(); return;
  }
  list.innerHTML=available.map(function(i){
    var already=trip?trip.gear.find(function(g){return g.itemId===i.id;}):null;
    var sel=pickerSels[i.id]||'';
    // All data passed via data-* attributes — NO inline variables in oninput
    return '<div class="picker-item'+(sel?' selected':'')+'" id="pr'+i.id+'">'
      +'<div style="flex:1"><div class="picker-name">'+esc(i.name)+'</div>'
      +'<div class="picker-cat">'+esc(i.cat||'')+(already?' <span style="color:var(--warn)">('+already.qty+' already loaded)</span>':'')+'</div></div>'
      +'<div class="picker-avail">avail: '+i.qty+'</div>'
      +'<input class="picker-qty" type="number" min="0" max="'+i.qty+'" placeholder="qty" value="'+sel+'"'
      +' data-item-id="'+i.id+'" data-max="'+i.qty+'" oninput="onPickerInput(this)">'
      +'</div>';
  }).join('');
  updatePickerSummary();
}

function onPickerInput(el) {
  // Read ONLY from data attributes — no closure vars, no eval, no floats
  var itemId = parseInt(el.getAttribute('data-item-id'), 10);
  var max    = parseInt(el.getAttribute('data-max'),     10);
  var n      = parseInt(el.value, 10);
  if (isNaN(n)||n<0) n=0;
  if (n>max)         { n=max; el.value=max; }
  var row = document.getElementById('pr'+itemId);
  if (n>0) {
    pickerSels[itemId]=n;
    if(row) row.classList.add('selected');
  } else {
    delete pickerSels[itemId];
    if(row) row.classList.remove('selected');
  }
  updatePickerSummary();
}

function updatePickerSummary() {
  var el      = document.getElementById('load-summary');
  var entries = Object.keys(pickerSels).filter(function(k){return pickerSels[k]>0;});
  if(!entries.length){el.textContent='Enter quantities above to select items.';el.style.color='var(--muted)';return;}
  var total=entries.reduce(function(s,k){return s+pickerSels[k];},0);
  el.textContent='\u2713 '+entries.length+' item type'+(entries.length!==1?'s':'')+' \u2014 '+total+' unit'+(total!==1?'s':'')+' ready to load';
  el.style.color='var(--ok)';
}

function confirmLoad() {
  var entries=Object.keys(pickerSels).filter(function(k){return pickerSels[k]>0;});
  if(!entries.length){showToast('Enter a quantity for at least one item',true);return;}
  var t=tripById(selectedTripId); if(!t) return;
  var loaded=0;
  entries.forEach(function(idStr){
    var itemId=parseInt(idStr,10);
    var qty=pickerSels[itemId];
    var item=itemById(itemId);
    if(!item||qty<=0) return;
    var actual=Math.min(qty,item.qty);
    if(actual<=0) return;
    item.qty-=actual;
    var existing=t.gear.find(function(g){return g.itemId===itemId;});
    if(existing){existing.qty+=actual;}
    else{t.gear.push({itemId:itemId,itemName:item.name,itemCat:item.cat||'',qty:actual});}
    loaded+=actual;
  });
  if(loaded===0){showToast('No stock available for selected items',true);return;}
  if(t.status==='planned') t.status='active';
  persist(); closeModal('load-modal'); renderAll(); renderTripsPage();
  showToast(loaded+' unit'+(loaded!==1?'s':'')+' loaded into trip!');
}

// ── MODAL HELPERS ────────────────────────────────────────────────────────────
function openModal(id)  {document.getElementById(id).classList.add('open');}
function closeModal(id) {document.getElementById(id).classList.remove('open');}

// ── TOAST ────────────────────────────────────────────────────────────────────
function showToast(msg,isError) {
  var old=document.querySelector('.toast'); if(old) old.remove();
  var t=document.createElement('div');
  t.className='toast'+(isError?' error':'');
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(function(){t.remove();},2600);
}

// ── EVENTS ───────────────────────────────────────────────────────────────────
['edit-modal','load-modal'].forEach(function(id){
  document.getElementById(id).addEventListener('click',function(e){if(e.target===this)closeModal(id);});
});
document.addEventListener('keydown',function(e){if(e.key==='Escape')['edit-modal','load-modal'].forEach(closeModal);});

// ── BOOT ─────────────────────────────────────────────────────────────────────
loadData();
renderAll();
</script>
</body>
</html>
